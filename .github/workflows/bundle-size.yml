name: Bundle Size

on:
  pull_request:
    branches: [main, develop]

jobs:
  size:
    name: Check Bundle Size
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build library
        run: npm run build

      - name: Check bundle size with size-limit
        run: npm run size

      - name: Generate size report
        run: |
          echo "## ðŸ“¦ Bundle Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Bundle Sizes (gzipped)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ESM bundle
          ESM_SIZE=$(stat -c %s dist/liquid-justice.mjs.gz | awk '{printf "%.2f KB", $1/1024}')
          echo "- **ESM**: $ESM_SIZE" >> $GITHUB_STEP_SUMMARY

          # CJS bundle
          CJS_SIZE=$(stat -c %s dist/liquid-justice.cjs.gz | awk '{printf "%.2f KB", $1/1024}')
          echo "- **CJS**: $ESM_SIZE" >> $GITHUB_STEP_SUMMARY

          # CSS bundle
          if [ -f dist/liquid-justice.css.gz ]; then
            CSS_SIZE=$(stat -c %s dist/liquid-justice.css.gz | awk '{printf "%.2f KB", $1/1024}')
            echo "- **CSS**: $CSS_SIZE" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Size Limits" >> $GITHUB_STEP_SUMMARY
          echo "- **Total**: < 100 KB (gzipped)" >> $GITHUB_STEP_SUMMARY
          echo "- **CSS**: < 20 KB (gzipped)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Full report available in bundle analyzer (dist/stats.html)" >> $GITHUB_STEP_SUMMARY

      - name: Upload bundle analyzer report
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analyzer
          path: dist/stats.html
          retention-days: 30

      - name: Comment PR with bundle size
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            const esmSize = fs.statSync('dist/liquid-justice.mjs.gz').size;
            const cjsSize = fs.statSync('dist/liquid-justice.cjs.gz').size;

            const formatSize = (bytes) => {
              return (bytes / 1024).toFixed(2) + ' KB';
            };

            const body = `## ðŸ“¦ Bundle Size Report

            | Bundle | Size (gzipped) | Limit |
            |--------|---------------|-------|
            | ESM | ${formatSize(esmSize)} | 100 KB |
            | CJS | ${formatSize(cjsSize)} | 100 KB |

            âœ… All bundles are within size limits!

            ðŸ“Š [View detailed bundle analysis](../actions/runs/${{ github.run_id }})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
